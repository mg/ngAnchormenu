/*
Copyright (c) 2014 Magnús Örn Gylfason
Licence: MIT
*/
!function(e){"use strict";function n(){return i}var t=e.module("ngPagemenu",[]),i={onRun:null,state:null,store:function(e){for(var n in e)this[n]=e[n];this.state=!0,this.run()},builder:null,setBuilder:function(e){this.builder=e,this.run()},run:function(){this.builder&&this.state&&(this.builder(),this.builder=null,this.state=null,this.onRun&&(this.onRun(),this.onRun=null))}};t.directive("pagemenu",function(e,t,i){var s=function(s,r){for(var l,u=[],o=[],a=function(e){for(var n={link:e.id,text:e.innerText,parent:""},t=e.tagName,i=0;i<e.classList.length;i++)t+=","+e.classList[i];var s=u.length;if(0===s)u.push(t);else if(t!==u[s-1]){for(var r=s-1;r>=0&&t!=u[r];r--);if(0>r)u.push(t),n.push=!0,o.push(l);else for(n.pop=s-1-r;u.length>r+1;)u.pop(),o.pop()}return o.length>0&&(n.parent=o[o.length-1]),l=n.link,n},p=n().items(),c="",f=0;f<p.length;f++){var g=a(p[f]);if(g.push)c+='<ul class="nav">';else if(g.pop)for(var h=0;h<g.pop;h++)c+="</li></ul>";else 0!==f&&(c+="</li>");c+='<li pagemenuspy="'+g.link+'" parent="'+g.parent+'">',c+='<a href="#'+g.link+'">',c+=g.text,c+="</a>"}c+="</li>",r.append(e(c)(s)),r.on("click",function(e){var s=e.target.hash.substring(1);t.hash(s),i(),setTimeout(function(){window.scrollTo(window.pageXOffset,window.pageYOffset-n().topMargin())},0)})};return{restrict:"E",replace:!0,template:'<ul class="nav pagemenu"></ul>',link:function(e,t){n().setBuilder(function(){s(e,t)})}}}),t.directive("pagemenuspy",function(){return{restrict:"A",link:function(e,t,i){n().addSpy({id:i.pagemenuspy,parent:i.parent,set:function(){t.addClass("active");var e=n().getSpy(this.parent);e&&e.set()},clear:function(){t.removeClass("active")}})}}}),t.directive("pageitems",function(t,i){var s=function(s,r){if(e.isDefined(s.selector)){s.spyElems=r[0].getElementsByClassName(s.selector),s.spies={},n().onRun=function(){s.spies[s.spyElems[0].id].set()},n().store({topMargin:function(){return 0|s.topmargin},addSpy:function(e){s.spies[e.id]=e},getSpy:function(e){return s.spies[e]},items:function(){return s.spyElems}});var l=s.spyElems,u=0|s.topmargin,o=e.element(t);o.on("scroll",function(){for(var e=null,n=s.spies,r=0;r<l.length;r++){var o=l[r],a=n[o.id];if(a.clear(),void 0!==o.getBoundingClientRect().top){var p=o.getBoundingClientRect().top;u>=p?(a.pos=p,null===e&&(e=a),e.pos<a.pos&&(e=a)):null===e&&(e=a)}}t.innerHeight+t.scrollY>=i[0].body.offsetHeight&&(e=n[l[l.length-1].id]),e.set()})}};return{restrict:"A",scope:{selector:"@",topmargin:"@"},link:s}})}(angular);