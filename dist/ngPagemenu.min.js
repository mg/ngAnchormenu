/*
Copyright (c) 2014 Magnús Örn Gylfason
Licence: MIT
*/
!function(n){"use strict";function e(){return i}var t=n.module("ngPagemenu",[]),i={onRun:null,state:null,store:function(n){for(var e in n)this[e]=n[e];this.state=!0,this.run()},builder:null,setBuilder:function(n){this.builder=n,this.run()},run:function(){this.builder&&this.state&&(this.builder(),this.builder=null,this.state=null,this.onRun&&(this.onRun(),this.onRun=null))}};t.directive("pagemenu",["$compile","$location","$anchorScroll",function(n,t,i){var s=function(s,r){for(var l,o=[],u=[],a=function(n){for(var e={link:n.id,text:n.innerText,parent:""},t=n.tagName,i=0;i<n.classList.length;i++)t+=","+n.classList[i];var s=o.length;if(0===s)o.push(t);else if(t!==o[s-1]){for(var r=s-1;r>=0&&t!=o[r];r--);if(0>r)o.push(t),e.push=!0,u.push(l);else for(e.pop=s-1-r;o.length>r+1;)o.pop(),u.pop()}return u.length>0&&(e.parent=u[u.length-1]),l=e.link,e},p=e().items(),c="",f=0;f<p.length;f++){var g=a(p[f]);if(g.push)c+='<ul class="nav">';else if(g.pop)for(var h=0;h<g.pop;h++)c+="</li></ul>";else 0!==f&&(c+="</li>");c+='<li pagemenuspy="'+g.link+'" parent="'+g.parent+'">',c+='<a href="#'+g.link+'">',c+=g.text,c+="</a>"}c+="</li>",r.append(n(c)(s)),r.on("click",function(n){var s=n.target.hash.substring(1);t.hash(s),i(),0!==e().topMargin()&&setTimeout(function(){window.scrollTo(window.pageXOffset,window.pageYOffset-e().topMargin())},0)})};return{restrict:"E",replace:!0,template:'<ul class="nav pagemenu"></ul>',link:function(n,t){e().setBuilder(function(){s(n,t)})}}}]),t.directive("pagemenuspy",["$location","$anchorScroll",function(){return{restrict:"A",link:function(n,t,i){e().addSpy({id:i.pagemenuspy,parent:i.parent,set:function(){t.addClass("active");var n=e().getSpy(this.parent);n&&n.set()},clear:function(){t.removeClass("active")}})}}}]),t.directive("pageitems",["$window","$document",function(t,i){var s=function(s,r){if(n.isDefined(s.selector)){s.spyElems=r[0].getElementsByClassName(s.selector),s.spies={},e().onRun=function(){s.spies[s.spyElems[0].id].set()},e().store({topMargin:function(){return 0|s.topmargin},addSpy:function(n){s.spies[n.id]=n},getSpy:function(n){return s.spies[n]},items:function(){return s.spyElems}});var l=s.spyElems,o=0|s.topmargin,u=n.element(t);u.on("scroll",function(){for(var n=null,e=s.spies,r=0;r<l.length;r++){var u=l[r],a=e[u.id];if(a.clear(),void 0!==u.getBoundingClientRect().top){var p=u.getBoundingClientRect().top;o>=p?(a.pos=p,null===n&&(n=a),n.pos<a.pos&&(n=a)):null===n&&(n=a)}}t.innerHeight+t.scrollY>=i[0].body.offsetHeight&&(n=e[l[l.length-1].id]),n.set()})}};return{restrict:"A",scope:{selector:"@",topmargin:"@"},link:s}}])}(angular);